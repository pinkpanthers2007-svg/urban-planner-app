<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Urban Planning AI Simulator</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Leaflet CSS & JS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <!-- Leaflet Draw Plugin CSS & JS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>

    <style>
        html, body, #map { height: 100%; width: 100%; margin: 0; padding: 0; overflow: hidden; font-family: sans-serif; background-color: #1a202c; }
        .leaflet-draw-toolbar, .leaflet-draw-actions { background-color: #2d3748 !important; border-radius: 8px !important; }
        .leaflet-draw-actions a { background-color: #4a5568 !important; }
        .animate-slide-in { animation: slideIn 0.5s cubic-bezier(0.250, 0.460, 0.450, 0.940) both; }
        @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }
        /* Base styles for all toolbar buttons */
        .toolbar-btn, .road-option, #ai-suggestion-btn {
            display: flex; align-items: center; padding: 0.5rem 1rem;
            border-radius: 0.375rem; transition: all 0.2s;
            color: #d1d5db; background-color: #374151;
            white-space: nowrap; cursor: pointer;
        }
        .toolbar-btn:hover, .road-option:hover, #ai-suggestion-btn:hover {
            background-color: #4b5563;
        }
        .active-btn {
            background-color: #2563eb !important; color: white !important;
        }
    </style>
</head>
<body>

    <div id="toolbar" class="absolute top-4 left-1/2 -translate-x-1/2 z-[1000] bg-gray-800 bg-opacity-80 backdrop-blur-sm p-2 rounded-lg shadow-2xl flex items-center space-x-2 text-sm">
        <button data-infra="hospital" class="toolbar-btn">Hospital</button>
        <button data-infra="park" class="toolbar-btn">Park</button>
        <button data-infra="mall" class="toolbar-btn">Mall</button>
        <button data-infra="school" class="toolbar-btn">School</button>
        <div class="relative group">
            <button id="road-main-btn" class="toolbar-btn">Road</button>
            <div class="absolute hidden group-hover:flex flex-col bg-gray-700 top-full pt-2 rounded-lg shadow-lg w-36">
                <a href="#" data-infra="road_ground" class="road-option">Ground Road</a>
                <a href="#" data-infra="road_flyover" class="road-option">Flyover</a>
                <a href="#" data-infra="road_tunnel" class="road-option">Tunnel</a>
            </div>
        </div>
        <button id="ai-suggestion-btn" class="bg-purple-600 hover:bg-purple-500">AI Suggestion</button>
    </div>

    <div id="map"></div>
    
    <div id="results-panel" class="hidden absolute top-0 right-0 h-full w-full sm:w-96 z-[1000] bg-gray-900 bg-opacity-80 backdrop-blur-md p-6 shadow-2xl text-white overflow-y-auto">
        <button id="close-results" class="absolute top-4 right-4 text-gray-400 hover:text-white transition-colors text-2xl font-bold">&times;</button>
        <h2 class="text-2xl font-bold mb-4 text-white">Simulation Report</h2>
        <div id="results-content" class="space-y-4"></div>
    </div>

    <div id="loading-spinner" class="hidden absolute inset-0 z-[2000] bg-black bg-opacity-50 flex items-center justify-center">
        <p class="text-white text-2xl animate-pulse">Running AI Simulation...</p>
    </div>

    <script>
        window.onload = function() {
            let selectedInfra = null;
            let drawControl = null;
            
            const toolbar = document.getElementById('toolbar');
            const resultsPanel = document.getElementById('results-panel');
            const resultsContent = document.getElementById('results-content');
            const closeResultsBtn = document.getElementById('close-results');
            const loadingSpinner = document.getElementById('loading-spinner');
            const aiSuggestionBtn = document.getElementById('ai-suggestion-btn');

            const map = L.map('map').setView([17.6868, 83.2185], 12);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { attribution: '&copy; OpenStreetMap' }).addTo(map);

            const drawnItems = new L.FeatureGroup();
            map.addLayer(drawnItems);

            fetch('https://mahesh20079-urban-planner-tool-ai.hf.space/api/wards')

                .then(response => response.json())
                .then(data => L.geoJSON(data, { style: () => ({ color: "#4a5568", weight: 1, fillColor: "#2d3748", fillOpacity: 0.4 }) }).addTo(map))
                .catch(error => console.error("Failed to fetch ward data:", error));

            toolbar.addEventListener('click', (event) => {
                event.preventDefault();
                const target = event.target.closest('[data-infra]');
                if (!target) return;
                selectedInfra = target.dataset.infra;
                document.querySelectorAll('.toolbar-btn, .road-option').forEach(btn => btn.classList.remove('active-btn'));
                if (target.classList.contains('road-option')) {
                    document.getElementById('road-main-btn').classList.add('active-btn');
                }
                target.classList.add('active-btn');
                updateDrawControl();
            });
            
            closeResultsBtn.addEventListener('click', () => resultsPanel.classList.add('hidden'));

            aiSuggestionBtn.addEventListener('click', async () => {
                if (!selectedInfra) {
                    alert("Please select an infrastructure type first (e.g., Park, Mall) to get a suggestion.");
                    return;
                }
                loadingSpinner.classList.remove('hidden');
                try {
                    const response = await fetch(`https://mahesh20079-urban-planner-tool-ai.hf.space/api/suggest-placement/${selectedInfra}`);
                    if (!response.ok) {
                        const err = await response.json();
                        throw new Error(err.detail || "Suggestion could not be generated.");
                    }
                    const suggestion = await response.json();
                    alert(`AI SUGGESTION:\n\nWard: ${suggestion.ward_name}\n\nReason: ${suggestion.reason}`);
                    map.flyTo([suggestion.latitude, suggestion.longitude], 14);
                } catch (error) {
                    alert(`Error getting suggestion: ${error.message}`);
                } finally {
                    loadingSpinner.classList.add('hidden');
                }
            });

            function updateDrawControl() {
                if (drawControl) map.removeControl(drawControl);
                const isArea = selectedInfra === 'park' || selectedInfra === 'mall';
                const isPoint = selectedInfra === 'hospital' || selectedInfra === 'school';
                const isLine = selectedInfra && selectedInfra.startsWith('road');
                
                drawControl = new L.Control.Draw({
                    draw: { polygon: isArea, marker: isPoint, polyline: isLine, rectangle: false, circle: false, circlemarker: false },
                    edit: { featureGroup: drawnItems },
                });
                map.addControl(drawControl);
            }
            updateDrawControl();

            map.on(L.Draw.Event.CREATED, async (event) => {
                if (!selectedInfra) return;
                
                drawnItems.clearLayers();
                drawnItems.addLayer(event.layer);
                loadingSpinner.classList.remove('hidden');

                try {
                    const response = await fetch('https://mahesh20079-urban-planner-tool-ai.hf.space/api/simulate', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ infrastructure_type: selectedInfra, geometry: event.layer.toGeoJSON().geometry }),
                    });
                    const result = await response.json();
                    displayResults(result);
                } catch (error) {
                    displayResults({ status: 'error', message: `Failed to run simulation: ${error}` });
                } finally {
                    loadingSpinner.classList.add('hidden');
                }
            });

            // --- THIS IS THE NEW, "SUPER OP" DYNAMIC DISPLAY FUNCTION ---
            function displayResults(result) {
                let content = '';
                if (result.message || result.status !== 'success') {
                    content = `<p class="text-red-400">${result.message || 'An unknown error occurred.'}</p>`;
                } else {
                    let reportHtml = `<h3 class="text-xl font-bold text-blue-300">Analysis for: ${result.infrastructure_type}</h3>`;
                    reportHtml += `<p class="italic text-gray-400 text-sm mb-4">${result.summary_narrative}</p>`;

                    // Dynamically build each section only if it exists in the response
                    if (result.environmental_impact) {
                        const impact = result.environmental_impact;
                        reportHtml += `<div class="mt-3 border-t border-gray-700 pt-3"><h4 class="font-semibold text-gray-200">Environmental Impact</h4>`;
                        reportHtml += `<p class="text-sm italic text-gray-400 mt-1">${impact.narrative}</p>`;
                        if (impact.predicted_aqi_change != null) reportHtml += `<p><strong>AQI Change:</strong> ${impact.predicted_aqi_change > 0 ? '+' : ''}${impact.predicted_aqi_change.toFixed(2)}</p>`;
                        if (impact.predicted_heat_index_change != null) reportHtml += `<p><strong>Heat Index Change:</strong> ${impact.predicted_heat_index_change > 0 ? '+' : ''}${impact.predicted_heat_index_change.toFixed(2)}°C</p>`;
                        if (impact.predicted_urban_vegetation_change_percent != null) reportHtml += `<p><strong>Urban Vegetation Change:</strong> ${impact.predicted_urban_vegetation_change_percent.toFixed(2)}%</p>`;
                        reportHtml += `</div>`;
                    }
                    if (result.traffic_impact) {
                        const impact = result.traffic_impact;
                        reportHtml += `<div class="mt-3 border-t border-gray-700 pt-3"><h4 class="font-semibold text-gray-200">Traffic Impact</h4>`;
                        reportHtml += `<p class="text-sm italic text-gray-400 mt-1">${impact.narrative}</p>`;
                        if (impact.predicted_traffic_density_change_percent != null) reportHtml += `<p><strong>Density Change:</strong> ${impact.predicted_traffic_density_change_percent > 0 ? '+' : ''}${impact.predicted_traffic_density_change_percent.toFixed(2)}%</p>`;
                        if (impact.predicted_light_vehicle_change_percent != null) reportHtml += `<p><strong>Light Vehicle Change:</strong> ${impact.predicted_light_vehicle_change_percent > 0 ? '+' : ''}${impact.predicted_light_vehicle_change_percent.toFixed(2)}%</p>`;
                        if (impact.predicted_medium_vehicle_change_percent != null) reportHtml += `<p><strong>Medium Vehicle Change:</strong> ${impact.predicted_medium_vehicle_change_percent > 0 ? '+' : ''}${impact.predicted_medium_vehicle_change_percent.toFixed(2)}%</p>`;
                        if (impact.predicted_heavy_vehicle_change_percent != null) reportHtml += `<p><strong>Heavy Vehicle Change:</strong> ${impact.predicted_heavy_vehicle_change_percent > 0 ? '+' : ''}${impact.predicted_heavy_vehicle_change_percent.toFixed(2)}%</p>`;
                        reportHtml += `</div>`;
                    }
                    if (result.population_impact) {
                        const impact = result.population_impact;
                        reportHtml += `<div class="mt-3 border-t border-gray-700 pt-3"><h4 class="font-semibold text-gray-200">Population Impact</h4>`;
                        reportHtml += `<p class="text-sm italic text-gray-400 mt-1">${impact.narrative}</p>`;
                        if (impact.predicted_total_population_change != null) reportHtml += `<p><strong>Population Change:</strong> ${impact.predicted_total_population_change > 0 ? '+' : ''}${impact.predicted_total_population_change}</p>`;
                        if (impact.predicted_age_group_most_affected != null) reportHtml += `<p><strong>Most Affected Age Group:</strong> ${impact.predicted_age_group_most_affected}</p>`;
                        reportHtml += `</div>`;
                    }
                    if (result.economic_impact) {
                        const impact = result.economic_impact;
                        reportHtml += `<div class="mt-3 border-t border-gray-700 pt-3"><h4 class="font-semibold text-gray-200">Economic Impact</h4>`;
                        reportHtml += `<p class="text-sm italic text-gray-400 mt-1">${impact.narrative}</p>`;
                        if (impact.predicted_gdp_change_crore != null) reportHtml += `<p><strong>GDP Change:</strong> ₹${impact.predicted_gdp_change_crore.toFixed(2)} Crore</p>`;
                        reportHtml += `</div>`;
                    }
                    content = reportHtml;
                }
                
                resultsContent.innerHTML = content;
                resultsPanel.classList.remove('hidden');
                resultsPanel.classList.add('animate-slide-in');
            }
        };
    </script>
</body>
</html>